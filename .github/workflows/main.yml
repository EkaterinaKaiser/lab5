name: Lab

on:
  push:
    branches: [ main ]

jobs:
  deploy-cloud:
    runs-on: self-hosted
    env:
      HOST: localhost
    steps:
      - uses: actions/checkout@v4

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.CLOUD_SSH_KEY }}

      - name: Install docker-compose
        run: |
          # Проверяем наличие docker compose (встроенная команда)
          if command -v docker &> /dev/null && docker compose version &> /dev/null 2>&1; then
            echo "docker compose уже установлен"
            mkdir -p ~/.local/bin
            ln -sf $(which docker) ~/.local/bin/docker-compose 2>/dev/null || true
            export PATH="$HOME/.local/bin:$PATH"
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          elif [ -f /usr/local/bin/docker-compose ] || [ -f /usr/bin/docker-compose ]; then
            echo "docker-compose уже установлен"
          else
            # Устанавливаем в домашнюю директорию (не требует sudo)
            echo "Установка docker-compose в ~/.local/bin"
            mkdir -p ~/.local/bin
            curl -L "https://github.com/docker/compose/releases/download/v2.26.0/docker-compose-$(uname -s)-$(uname -m)" -o ~/.local/bin/docker-compose
            chmod +x ~/.local/bin/docker-compose
            export PATH="$HOME/.local/bin:$PATH"
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi
          docker-compose --version || docker compose version

      - name: Stop containers
        run: |
          docker-compose -f docker-compose.yml down -v --remove-orphans || docker compose -f docker-compose.yml down -v --remove-orphans || true

      - name: Run deployment script
        env:
          DEBIAN_FRONTEND: noninteractive
          DEBIAN_PRIORITY: critical
          # Автоматические ответы для iptables-persistent через переменные окружения
          IPTABLES_PERSISTENT_AUTOSAVE_V4: "false"
          IPTABLES_PERSISTENT_AUTOSAVE_V6: "false"
        run: |
          # Ждем разблокировки debconf, если он заблокирован
          while sudo fuser /var/cache/debconf/config.dat >/dev/null 2>&1; do
            echo "Ожидание разблокировки debconf..."
            sleep 2
          done
          # Устанавливаем ответы для debconf (если не заблокирован)
          echo "iptables-persistent iptables-persistent/autosave_v4 boolean false" | sudo debconf-set-selections 2>/dev/null || true
          echo "iptables-persistent iptables-persistent/autosave_v6 boolean false" | sudo debconf-set-selections 2>/dev/null || true
          bash deploy.sh
          sleep 10

      - name: Start containers
        run: |
          docker-compose -f docker-compose.yml up -d || docker compose -f docker-compose.yml up -d

      - name: Test Suricata
        run: |
          bash test-suricata.sh

      - name: Setup blocking rules
        run: |
          sudo bash setup_blocking_rules.sh